<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Destiny Blue — Your AI Concierge</title>
<style>
  :root { --bg:#f8fafc; --card:#fff; --border:#e5e7eb; --text:#0f172a; --muted:#6b7280; --primary:#2563eb; }
  body { margin:0; background:var(--bg); font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:var(--text); }
  .wrap { max-width:840px; margin:24px auto; padding:0 16px; }
  h1 { font-size:24px; margin:0 0 12px; }
  .chat { background:var(--card); border:1px solid var(--border); border-radius:16px; height:440px; overflow:auto; padding:12px; }
  .row { margin:8px 0; display:flex; }
  .bubble { padding:9px 12px; border-radius:12px; max-width:75%; }
  .user { justify-content:flex-end; }
  .user .bubble { background:#0f172a; color:#fff; }
  .bot .bubble { background:#f1f5f9; color:#111827; }
  .input { display:flex; gap:8px; margin-top:10px; }
  .input textarea { flex:1; padding:11px; border:1px solid var(--border); border-radius:12px; resize:none; font:inherit; line-height:1.3; }
  .input button { padding:11px 16px; border:0; border-radius:12px; background:var(--primary); color:#fff; font-weight:600; cursor:pointer; }
  .hint { font-size:12px; color:var(--muted); margin-top:8px; }

  /* chips */
  .chips { display:flex; flex-wrap:wrap; gap:8px; margin:10px 0 6px; }
  .chips button { padding:8px 12px; border:1px solid var(--border); background:#fff; border-radius:999px; font-size:14px; cursor:pointer; }
  .chips button:hover { border-color: var(--primary); }

  /* links in bubbles */
  .bubble a { color: var(--primary); text-decoration: underline; word-break: break-word; }
  .bubble a:hover { text-decoration: underline; opacity:.9; }

  @media (max-width: 640px) { .chat { height: 65vh; } }
</style>
</head>
<body>
<div class="wrap">
  <h1>Destiny Blue — Your AI Concierge</h1>
  <div id="chat" class="chat"></div>

  <div class="chips">
    <button class="chip" data-q="rates">Rates</button>
    <button class="chip" data-q="tax">Taxes</button>
    <button class="chip" data-q="deposit">Deposit</button>
    <button class="chip" data-q="payment">Payment</button>
    <button class="chip" data-q="beach chairs">Beach Chairs</button>
    <button class="chip" data-q="pools">Pools</button>
    <button class="chip" data-q="wifi">Wi-Fi</button>
    <button class="chip" data-q="parking">Parking</button>
  </div>

  <div class="input">
    <textarea id="q" rows="1" placeholder="Ask about Wi-Fi, parking, rules, amenities…" autofocus inputmode="text"></textarea>
    <button id="send">Send</button>
  </div>
  <div class="hint">Answers come from your property notes only. If I’m not sure, I’ll show how to reach the owner.</div>
</div>

<script>
  // Slightly higher to avoid weak matches
  const MATCH_THRESHOLD = 0.20;
  const NO_MATCH_MESSAGE = "I couldn’t find that in my notes — please use https://www.destincondogetaways.com/book to send an inquiry.";

  // EMBED MODE
  const params = new URLSearchParams(location.search);
  if (params.get('embed') === '1') {
    const wrap = document.querySelector('.wrap');
    const h1 = document.querySelector('.wrap h1');
    const hint = document.querySelector('.hint');
    if (h1) h1.style.display = 'none';
    if (hint) hint.style.display = 'none';
    if (wrap) wrap.style.marginTop = '8px';
  }

  // Synonyms (no "lot" in parking)
  const SYN = {
    rates:     ['rate','rates','price','pricing','cost','nightly','seasonal'],
    tax:       ['tax','taxes','fee','fees','percentage'],
    insurance: ['insurance','travel','protection','play','policy','refund'],
    deposit:   ['deposit','hold','security','damage'],
    payment:   ['payment','pay','card','cards','credit','ach','paypal','zelle'],
    modify:    ['modify','extend','change','edit','move'],
    discount:  ['discount','weekly','monthly','promo','coupon','code'],
    minimum:   ['minimum','min','nights','stay','blackout','holiday','requirement'],

    beach:        ['beach','shore','ocean','gulf','boardwalk','private','access'],
    view:         ['view','oceanview','gulfview','beachview','seaview'],
    beachchairs:  ['beach','chairs','chair','umbrella','lounger','gear'],
    beachrent:    ['rent','rental','ldv','cabana'],

    wifi:      ['wifi','wi-fi','wi','fi','internet','network','speed','ssid'],
    occupancy: ['occupancy','guests','people','capacity','max','maximum'],
    parking:   ['parking','garage','fee','complimentary','pass'], // no "lot"
    blog:      ['recommendations','blog','restaurants','activities','things','todo','to-do'],

    checkin:   ['check-in','checkin','arrival'],
    checkout:  ['check-out','checkout','departure'],
    smoking:   ['smoking','smoke','vape','vaping','cigarette','designated'],
    pools:     ['pool','pools','indoor','outdoor','heated','kiddie','jacuzzi','hot','tub','spa'],
    pets:      ['pets','pet','dog','cat','service','animal','esa']
  };

  // Expanded stopwords: filler + location + months
  const STOP = new Set([
    'a','an','the','of','in','on','to','for','and','or','is','are','am',
    'it','this','that','do','does','did','my','your','our','we','you','i',
    'lot','lots','destin','florida',
    'january','february','march','april','may','june','july','august','september','october','november','december'
  ]);

  // --- NEW: tiny stemmer so towel/towels, fees/fee, chairs/chair, etc. match
  function stem(w){
    w = w.toLowerCase();
    if (w.endsWith('ies') && w.length > 4) return w.slice(0,-3) + 'y';
    if (w.endsWith('es')  && w.length > 4) return w.slice(0,-2);
    if (w.endsWith('s')   && w.length > 3) return w.slice(0,-1);
    return w;
  }

  const norm  = s => (s||'').toLowerCase().replace(/[^\p{L}\p{N}\s]/gu,' ').replace(/\s+/g,' ').trim();

  // UPDATED: apply stem() to tokens
  const words = s => norm(s)
    .split(' ')
    .filter(w => w && !STOP.has(w))
    .map(stem);

  // Safe link rendering
  function escapeHTML(s){ return (s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  function linkify(text){
    let t = escapeHTML(text).replace(/\n/g,'<br>');
    t = t.replace(/\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}\b/g, '<a href="mailto:$&">$&</a>');
    t = t.replace(/((https?:\/\/|www\.)[^\s<)]+)/gi, m => {
      const url = /^www\./i.test(m) ? 'https://' + m : m;
      return `<a href="${url}" target="_blank" rel="noopener">${m}</a>`;
    });
    return t;
  }

  // Expand query tokens with synonyms
  const expand = s => {
    const set = new Set(words(s));
    for (const [k, a] of Object.entries(SYN)) {
      if (set.has(k) || a.some(x => set.has(x.replace(/\s+/g,'')))) {
        set.add(k);
        a.forEach(x => set.add(x.replace(/\s+/g,'')));
      }
    }
    return set;
  };

  // Detailed scoring (returns overlaps and tagHits too)
  function scoreDetails(qt, it){
    const hay    = words([it.q,it.a,it.title,it.content,...(it.tags||[])].join(' '));
    const toks   = new Set(hay);

    let overlaps = 0;
    for (const t of qt) if (toks.has(t)) overlaps++;

    // UPDATED: stem tags too
    const tagSet = new Set((it.tags || [])
      .map(x => stem(norm(x)))
      .filter(w => !STOP.has(w)));

    let tagHits  = 0;
    for (const t of qt) if (tagSet.has(t)) tagHits++;

    const cov   = overlaps / Math.max(3, qt.size);
    const score = cov * 0.7 + tagHits * 0.3;
    return { score, overlaps, tagHits };
  }

  const chat = document.getElementById('chat');
  const q    = document.getElementById('q');
  const btn  = document.getElementById('send');
  const msgs = []; let KB = null;

  function push(role, content){
    msgs.push({role,content});
    const row = document.createElement('div');
    row.className = 'row ' + (role==='user' ? 'user' : 'bot');
    const b = document.createElement('div');
    b.className = 'bubble';
    b.innerHTML = linkify(String(content||''));  // clickable links
    row.appendChild(b);
    chat.appendChild(row);
    chat.scrollTop = chat.scrollHeight;
  }

  function choose(text){
    if(!KB) return null;
    const qt = expand(text);
    const cand = [];

    (KB.faqs||[]).forEach(f => {
      const s = scoreDetails(qt, f);
      cand.push({ type:'faq', item:f, ...s });
    });
    (KB.docs||[]).forEach(d => {
      const s = scoreDetails(qt, d);
      cand.push({ type:'doc', item:d, ...s });
    });

    // also consider summary sections
    const basics   = KB.basics   ? Object.entries(KB.basics).map(([k,v]) => typeof v==='object'?`${k}: ${JSON.stringify(v)}`:`${k}: ${v}`).join(' | ') : '';
    const policies = KB.policies ? Object.entries(KB.policies).map(([k,v]) => `${k}: ${v}`).join(' | ') : '';
    const amenities= KB.amenities? Object.values(KB.amenities).flat().join(', ') : '';
    [{title:'Basics',content:basics},{title:'Policies',content:policies},{title:'Amenities',content:amenities}]
      .forEach(x => {
        const s = scoreDetails(qt, x);
        cand.push({ type:'doc', item:x, ...s });
      });

    cand.sort((a,b)=>b.score-a.score);
    const best = cand[0];
    if (!best) return null;

    // Require threshold AND (≥2 overlaps OR a tag match)
    if (best.score < MATCH_THRESHOLD || (best.overlaps < 2 && best.tagHits < 1)) return null;

    if (best.type === 'faq') return best.item.a;
    const t = (best.item.title ? best.item.title + ': ' : '') + best.item.content;
    return t.length > 800 ? t.slice(0,780) + '…' : t;
  }

  async function main(){
    push('assistant',"Hi! I’m Destiny Blue. How can I help with your stay?");
    try{
      const r = await fetch('knowledge.json?v=' + Date.now(), { cache: 'no-store' });
      KB = await r.json();
    }catch(e){
      push('assistant','Could not load knowledge.json');
    }
  }
  main();

  function send(){
    const text = q.value.trim(); if(!text) return;
    push('user', text); q.value='';
    const ans   = choose(text);
    const email = (KB && KB.contact && KB.contact.ownerEmail) || null;
    const fallback = email ? `${NO_MATCH_MESSAGE} Email: ${email}` : NO_MATCH_MESSAGE;
    push('assistant', ans || fallback);
    q.style.height = '40px';
    q.focus();
  }

  q.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); send(); } });
  q.style.height = '40px';
  q.addEventListener('input', () => { q.style.height='auto'; q.style.height=Math.min(120,q.scrollHeight)+'px'; });

  // chips: click -> fill -> send
  document.querySelectorAll('.chip').forEach(btnEl => {
    btnEl.addEventListener('click', () => { q.value = btnEl.dataset.q || btnEl.textContent.trim(); send(); });
  });

  btn.onclick = send;
</script>
</body>
</html>
