<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Destiny Blue — Your AI Concierge</title>
<style>
  :root { --bg:#f8fafc; --card:#fff; --border:#e5e7eb; --text:#0f172a; --muted:#6b7280; --primary:#2563eb; }
  body { margin:0; background:var(--bg); font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:var(--text); }
  .wrap { max-width:840px; margin:24px auto; padding:0 16px; }
  h1 { font-size:24px; margin:0 0 12px; }
  .chat { background:var(--card); border:1px solid var(--border); border-radius:16px; height:440px; overflow:auto; padding:12px; }
  .row { margin:8px 0; display:flex; }
  .bubble { padding:9px 12px; border-radius:12px; max-width:75%; }
  .user { justify-content:flex-end; }
  .user .bubble { background:#0f172a; color:#fff; }
  .bot .bubble { background:#f1f5f9; color:#111827; }
  .input { display:flex; gap:8px; margin-top:10px; }
  /* textarea styling (replaces input) */
  .input textarea { flex:1; padding:11px; border:1px solid var(--border); border-radius:12px; resize:none; font:inherit; line-height:1.3; }
  .input button { padding:11px 16px; border:0; border-radius:12px; background:var(--primary); color:#fff; font-weight:600; cursor:pointer; }
  .hint { font-size:12px; color:var(--muted); margin-top:8px; }

  /* make links look like links inside bubbles */
  .bubble a { color: var(--primary); text-decoration: underline; word-break: break-word; }
  .bubble a:hover { text-decoration: underline; opacity: .9; }

  /* Taller chat on phones */
  @media (max-width: 640px) { .chat { height: 65vh; } }
</style>
</head>
<body>
<div class="wrap">
  <h1>Destiny Blue — Your AI Concierge</h1>
  <div id="chat" class="chat"></div>
  <div class="input">
    <!-- CHANGED: input -> textarea -->
    <textarea id="q" rows="1" placeholder="Ask about Wi-Fi, parking, rules, amenities…" autofocus inputmode="text"></textarea>
    <button id="send">Send</button>
  </div>
  <div class="hint">Answers come from your property notes only. If I’m not sure, I’ll show how to reach the owner.</div>
</div>

<script>
  // Tuning constants
  const MATCH_THRESHOLD = 0.18;
  const NO_MATCH_MESSAGE = "I couldn’t find that—please reach the owner via the inquiry link on the booking page.";

  // EMBED MODE: hide header + hint when ?embed=1
  const params = new URLSearchParams(location.search);
  if (params.get('embed') === '1') {
    const wrap = document.querySelector('.wrap');
    const h1 = document.querySelector('.wrap h1');
    const hint = document.querySelector('.hint');
    if (h1) h1.style.display = 'none';
    if (hint) hint.style.display = 'none';
    if (wrap) wrap.style.marginTop = '8px';
  }

  // Expanded synonym map (covers your new FAQs)
  const SYN = {
    // Pricing & policy
    rates:     ['rate','rates','price','pricing','cost','nightly','seasonal'],
    tax:       ['tax','taxes','fee','fees','percentage'],
    insurance: ['insurance','travel','protection','play','policy','refund'],
    deposit:   ['deposit','hold','security','damage'],
    payment:   ['payment','pay','card','cards','credit','ach','paypal','zelle'],
    modify:    ['modify','extend','change','edit','move'],
    discount:  ['discount','weekly','monthly','promo','coupon','code'],
    minimum:   ['minimum','min','nights','stay','blackout','holiday','requirement'],

    // Beach & amenities
    beach:        ['beach','shore','ocean','gulf','boardwalk','private','access'],
    view:         ['view','oceanview','gulfview','beachview','seaview'],
    beachchairs:  ['beach','chairs','chair','umbrella','lounger','gear'],
    beachrent:    ['rent','rental','ldv','cabana'],

    // Basics
    wifi:      ['wifi','wi-fi','wi','fi','internet','network','speed','ssid'],
    occupancy: ['occupancy','guests','people','capacity','max','maximum'],
    parking:   ['parking','garage','lot','fee','complimentary','pass'],
    blog:      ['recommendations','blog','restaurants','activities','things','todo','to-do'],

    // Times & rules
    checkin:   ['check-in','checkin','arrival'],
    checkout:  ['check-out','checkout','departure'],
    smoking:   ['smoking','smoke','vape','vaping','cigarette','designated'],
    pools:     ['pool','pools','indoor','outdoor','heated','kiddie','jacuzzi','hot','tub','spa'],
    pets:      ['pets','pet','dog','cat','service','animal','esa']
  };

  const norm = s => (s||'').toLowerCase().replace(/[^\p{L}\p{N}\s]/gu,' ').replace(/\s+/g,' ').trim();

  // Helpers to make URLs/emails clickable safely
  function escapeHTML(s){
    return (s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }
  function linkify(text){
    let t = escapeHTML(text).replace(/\n/g,'<br>');
    // emails
    t = t.replace(/\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}\b/g, '<a href="mailto:$&">$&</a>');
    // urls (http(s) or www.)
    t = t.replace(/((https?:\/\/|www\.)[^\s<)]+)/gi, (m) => {
      const url = /^www\./i.test(m) ? 'https://' + m : m;
      return `<a href="${url}" target="_blank" rel="noopener">${m}</a>`;
    });
    return t;
  }

  const expand = s => {
    const t = norm(s);
    const set = new Set(t.split(' ').filter(Boolean));
    for (const [k, a] of Object.entries(SYN)) {
      if (set.has(k) || a.some(x => set.has(x.replace(/\s+/g,'')))) {
        set.add(k);
        a.forEach(x => set.add(x.replace(/\s+/g,'')));
      }
    }
    return set;
  };

  const score = (qt, it) => {
    const hay = norm([it.q,it.a,it.title,it.content,...(it.tags||[])].join(' '));
    const toks = new Set(hay.split(' ').filter(Boolean));
    let ov = 0; for (const t of qt) if (toks.has(t)) ov++;
    const tags = new Set((it.tags||[]).map(norm));
    let tag = 0; for (const t of qt) if (tags.has(t)) tag++;
    const cov = ov / Math.max(3, qt.size);
    return cov*0.7 + tag*0.3;
  };

  const chat = document.getElementById('chat');
  const q = document.getElementById('q');
  const btn = document.getElementById('send');
  const msgs = []; let KB=null;

  function push(role, content){
    msgs.push({role,content});
    const row = document.createElement('div');
    row.className = 'row ' + (role==='user' ? 'user' : 'bot');
    const b = document.createElement('div');
    b.className = 'bubble';
    b.innerHTML = linkify(content);  // linkify + safe HTML
    row.appendChild(b);
    chat.appendChild(row);
    chat.scrollTop = chat.scrollHeight;
  }

  function choose(text){
    if(!KB) return null; const qt=expand(text); const cand=[];
    (KB.faqs||[]).forEach(f=>cand.push({type:'faq',item:f,score:score(qt,f)}));
    (KB.docs||[]).forEach(d=>cand.push({type:'doc',item:d,score:score(qt,d)}));
    const basics=KB.basics?Object.entries(KB.basics).map(([k,v])=>typeof v==='object'?`${k}: ${JSON.stringify(v)}`:`${k}: ${v}`).join(' | '):'';
    const policies=KB.policies?Object.entries(KB.policies).map(([k,v])=>`${k}: ${v}`).join(' | '):'';
    const amenities=KB.amenities?Object.values(KB.amenities).flat().join(', '):'';
    [{title:'Basics',content:basics},{title:'Policies',content:policies},{title:'Amenities',content:amenities}]
      .forEach(x=>cand.push({type:'doc',item:x,score:score(qt,x)}));
    cand.sort((a,b)=>b.score-a.score);
    const best=cand[0];
    if(!best || best.score < MATCH_THRESHOLD) return null;
    if(best.type==='faq') return best.item.a;
    const t=(best.item.title?best.item.title+': ':'')+best.item.content;
    return t.length>800?t.slice(0,780)+'…':t;
  }

  async function main(){
    push('assistant',"Hi! I’m Destiny Blue. How can I help with your stay?");
    try{
      const r=await fetch('knowledge.json',{cache:'no-store'});
      KB=await r.json();
    }catch(e){
      push('assistant','Could not load knowledge.json');
    }
  }
  main();

  function send(){
    const text=q.value.trim(); if(!text) return;
    push('user',text); q.value='';
    const ans=choose(text);
    const email=(KB&&KB.contact&&KB.contact.ownerEmail)||null;
    const fallback = email ? `${NO_MATCH_MESSAGE} Email: ${email}` : NO_MATCH_MESSAGE;
    push('assistant', ans || fallback);
    q.style.height = '40px'; // reset after send
    q.focus();
  }

  // Enter to send (Shift+Enter for newline)
  q.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      send();
    }
  });

  // Auto-resize the textarea
  q.style.height = '40px';
  q.addEventListener('input', () => {
    q.style.height = 'auto';
    q.style.height = Math.min(120, q.scrollHeight) + 'px';
  });

  btn.onclick = send;
</script>
</body>
</html>
